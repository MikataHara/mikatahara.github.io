<!DOCTYPE html>
<HTML>
<HEAD>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta name="Keywords" content="webMIDIAPI,WebMidiApi,webmidiapi">
	<title>Mic to SP</title>

  <style type="text/css">
    <!--
    #sans { color: black; font-family:sans-serif ;  font-size: 10pt; line-height : 1.5em}
    #mono { color: black; font-family:monospace ; font-size: 10pt; line-height : 1.5em}

    #log {
     width:20em;
     height:12em;
     margin:.5em 0 .5em 0;
     padding:.5em;
     background-color:#eee;
     border:solid 1px #888;
//     background-color:#222222;
//     border:solid 1px #222222;
     white-space:pre;
     font-family:Courier New, monospace;
     font-size:.75em;
     overflow:auto;
    }
    -->
    </style>


<script>
{
	var audioContext = new AudioContext();
	var audiosource;
	var splitter = audioContext.createChannelSplitter(2);
	var merger = audioContext.createChannelMerger(2);
	var node = audioContext.createScriptProcessor(1024, 2, 2);

	// Gain Node for both channel
 	var gainL = audioContext.createGain();
	var gainR = audioContext.createGain();
	gainL.gain.value = 1.0;
	gainR.gain.value = 1.0;

	navigator.getUserMedia = ( navigator.getUserMedia ||
		navigator.webkitGetUserMedia ||
		navigator.mozGetUserMedia ||
		navigator.msGetUserMedia);

	function soundThrough() {
		navigator.getUserMedia({video: false, audio: true},

		function(stream){
			audiosource = audioContext.createMediaStreamSource(stream);
			audiosource.connect(node);
			node.connect(splitter);
			splitter.connect(gainL, 0);
			splitter.connect(gainR, 1);
			gainL.connect(merger, 0, 0)
			gainR.connect(merger, 0, 1)
			merger.connect(audioContext.destination);
		},

		function(e) {	// I can't use getUserMedia
			console.log(e);
		}
	);

}


}
</script>


<hr>
</HEAD>

<body onload="soundThrough();" bgcolor="#ccccff" text="#000000" link="#0000ff" vlink="#ff00ff" alink="#ff0000" style="margin-right:28px;margin-left:28px;margin-top:20px;">
<br>
<center><h2>Web MIDI API 実験室<h2></center>
<center><h4>getUserMediaで音をマイクの音を、スピーカから再生</h4>
<div id="sans">
<font color="red">このプログラムはスピーカボリュームが大きいとハウリングします</font><br>
(2015.4.29)波形の形状を表示<br>
(2016.1.9)httpsのサーバへ移動/UTF-8に変更</center>
</div>
<br>

<!--	-------------------------------------------------------------------- -->
<canvas id="waveshape" width="1048" height="224">
</canvas>

<pre id="log">
</pre>

<!--	------------------------------------------------------------------ -->

<script>
{
	var ixb = 12;	//描画X軸の基点
	var iyb = 12;	//描画Y軸の基点
	var ixw = 1024;	//描画のX軸のサイズ
	var iyw = 200;	//描画のX軸のサイズ

	/* 描画領域の初期化 */
	var canvas = document.getElementById('waveshape');
	var waveshape = canvas.getContext('2d');
    waveshape.strokeRect(ixb,iyb,ixw,iyw);

	/* Audio Buffer が一杯になったらこの関数が呼ばれる */
	function process(data){
		var procsize = data.inputBuffer.length;
		/* L-ch を描画する */
		var inbufL = data.inputBuffer.getChannelData(0);
		var inbufR = data.inputBuffer.getChannelData(1);
		var outbufL = data.outputBuffer.getChannelData(0);
		var outbufR = data.outputBuffer.getChannelData(1);

		waveshape.beginPath();
		var ix=iy=0;

		/* 描画領域のクリア */
	    waveshape.clearRect(ixb,iyb,ixw,iyw);

		/* 波形の表示 */
		waveshape.strokeStyle ="#000000";
		waveshape.moveTo(ixb, iyb+iyw/2);
		for(var i=0;i<procsize; i+=8){
			iy=Math.floor(inbufL[i]*100+iyw/2+iyb);
			if(iy >= iyw+iyb ) iy=iyw+iyb;
			else if(iy<=iyb ) iy=iyb;

			ix=Math.floor(i+ixb);
			waveshape.lineTo(ix, iy);
		}
		waveshape.stroke();

		for(var i=0; i<procsize; i++){ outbufL[i]=inbufL[i]; outbufR[i]=inbufR[i]; }

	}

	//データ処理関数の定義
	node.onaudioprocess=process;

	/* LOG領域の初期化 */
	var log = document.getElementById("log");
	var sampleRate = audioContext.sampleRate;

	log.innerText +="sample rate:"
	log.innerText += sampleRate;
	log.innerText +="\n";

	function leftGainChange(value){
		log.innerText +="left gain:"
		log.innerText +=value;
		log.innerText +="\n";
		gainL.gain.value = value;
	}
	function RightGainChange(value){
		log.innerText +="right gain:"
		log.innerText +=value;
		log.innerText +="\n";
		gainR.gain.value = value;
	}
}
</script>

<form method="volume">
LEFT &nbsp;&nbsp;GAIN: <input type="number" name="left"  step="0.1" min="0.0" max="1.0" value="1.0" onchange="leftGainChange(this.value);"><br>
RIGHT GAIN: <input type="number" name="right" step="0.1" min="0.0" max="1.0" value="1.0" onchange="RightGainChange(this.value);">
</form>

<div id="sans">
<br>
マイクの音を、getUserMediaで取り込む、Audio APIでちっとした加工をして、スピーカーから音を鳴らす。<br>
この実験では、ステレオの音の左右を、splitterで分解する。<br>
分解した音、それぞれに音の大きさを調整する。Gainノードを使う。<br>
左右、独立にボリューム調整した後、mergerノードで、もう一度左右を結合する。<br>
結合した音を、スピーカから出力する。<br>
<br>
<b>やっかいなポイント</b><br>

<font color="red">
getUserMediaは、ローカルでは使えない。<br>
getUserMediaを使ったファイル、xxxx.htmlを外のサーバにおいてhttp://...../xxxx.html として開かないと、ちゃんと動かない。<br>
</font>

</div>
<pre id="mono">

{
	var audioContext = new AudioContext(); &nbsp;&nbsp;<font color="blue">//Audio Api を立ち上げる
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;webkitAudioContext()は古い！と怒られる</font>
	var splitter = audioContext.createChannelSplitter(2); &nbsp;&nbsp;<font color="blue">//2ch のスプリッター、ステレオを２つのモノラルにする</font>
	var merger = audioContext.createChannelMerger(2); &nbsp;&nbsp;<font color="blue">//2ch のマージャー、２つのモノラルをステレオにする</font>
	var node = audioContext.createScriptProcessor(1024, 2, 2); &nbsp;&nbsp;<font color="blue">//オーディオデータを直接扱うためのnodeの定義
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;バッファーサイズを1024, 入力チャンネル数を２、出力チャンネル数を２とする</font>
	node.onaudioprocess=process;&nbsp;&nbsp;<font color="blue">//バッファーが一杯になったらこの関数へ飛ぶ</font>
	var audiosource;

	// Gain Node for both channel
 	var gainL = audioContext.createGain(); &nbsp;&nbsp;<font color="blue">//左チャンネル用のボリューム</font>
	var gainR = audioContext.createGain(); &nbsp;&nbsp;<font color="blue">//右チャンネル用のボリューム</font>
	gainL.gain.value = 0.0;&nbsp;&nbsp;<font color="blue">//左ボリュームをゼロ</font><font color="red"><b>&nbsp;gainL.value=0.0 ではダメ！</b></font>
	gainR.gain.value = 0.0;&nbsp;&nbsp;<font color="blue">//右ボリュームをゼロ</font>

	navigator.getUserMedia = ( navigator.getUserMedia ||
		navigator.webkitGetUserMedia ||
		navigator.mozGetUserMedia ||
		navigator.msGetUserMedia);&nbsp;&nbsp;<font color="blue">//おまじない。この行が無いと、getUserMediaが評価されない</font>

	function soundThrough() {
		navigator.getUserMedia({video: false, audio: true},&nbsp;&nbsp;<font color="blue">//getUserMediaを呼び出します。ここではaudioだけ使います</font>

		function(stream){&nbsp;&nbsp;<font color="blue">//getUserMediaの呼び出しに成功したら、この関数が呼ばれます</font>
			audiosource = audioContext.createMediaStreamSource(stream);&nbsp;&nbsp;<font color="blue">//getUserMediaで受け取った音(stream)を、audiosourceにつなぐ</font>
			<s>audiosource.connect(splitter); &nbsp;&nbsp;<font color="blue">//audiosourceを、スプリッターにつなぐ</font></s>
			audiosource.connect(node); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="blue">//audiosourceを、オーディオ処理nodeにつなぐ</font>
			node.connect(splitter); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="blue">//nodeの出力を、splitterにつなぐ</font>
			splitter.connect(gainL, 0); &nbsp;&nbsp;&nbsp;&nbsp;<font color="blue">//スプリッターのゼロ番目の出力をgainLにつなぐ</font>
			splitter.connect(gainR, 1); &nbsp;&nbsp;&nbsp;&nbsp;<font color="blue">//スプリッターのイチ番目の出力をgainRにつなぐ</font>
			gainL.connect(merger, 0, 0); &nbsp;&nbsp;&nbsp;<font color="blue">//gainLのゼロ番目の出力をmergerのゼロ番目の入力につなぐ</font>
			gainR.connect(merger, 0, 1); &nbsp;&nbsp;&nbsp;<font color="blue">//gainRのゼロ番目の出力をmergerのイチ番目の入力につなぐ</font>
			merger.connect(audioContext.destination);&nbsp;&nbsp;<font color="blue">//mergerの出力をスピーカにつなぐ</font>
		},

		function(e) {	;&nbsp;&nbsp;<font color="blue">//getUserMediaの呼び出しに<font color="red">失敗</font>したら、この関数が呼ばれます</font>
			console.log(e);
		}
	);

}


</pre>
</body>
</html>

